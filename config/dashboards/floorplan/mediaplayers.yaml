#################################################
#                                               #
#         MEDIA PLAYERS                         #
#                                               #
#################################################
- entity:
    - media_player.living_room_tv
  elements:
    - media_player.living_room_tv
    - media_player_overlay.living_room_tv
    - atv-entity-picture
    # - light.sony_tv_backlight
    - atv_idle_path
  tap_action: !include ../shared/honeycomb/atv.yaml
  double_tap_action: more-info
  state_action:
    - service: floorplan.class_set
      service_data: 'media-living-${entity.state}'
- element:
    - atv-entity-picture
  entities:
    - media_player.living_room_tv
    # - sensor.youtube_thumbnail
    # - media_player.kodi_atv
  state_action:
    - service: floorplan.image_set
      service_data:
        image: |
          >
          let mediaState = states['media_player.living_room_tv'].state;
          let appState = states['media_player.living_room_tv'].attributes.app_name;
          let haUrlEntity = `${this.hass.hassUrl().replace(/\/$/, '')}${states['media_player.living_room_tv'].attributes.entity_picture}`;
          let stremioEntityPic = `${states['media_player.living_room_tv'].attributes.entity_picture}`;
          console.log("Media State:", mediaState, "App State:", appState, "HA URL Entity:", haUrlEntity, "Stremio Entity Pic:", stremioEntityPic);
          if (mediaState === "playing" || mediaState === "paused") {
            if (appState === "YouTube") {
              return `${states['sensor.youtube_thumbnail'].state}`;
            } else if (appState === "Spotify") {
                return haUrlEntity;
            } else if (appState === "Stremio") {
              return stremioEntityPic;
            };
            return "/local/hafloor/transparent_idle.png";
          } else {
            return "/local/hafloor/transparent_idle.png";
          }

- entities:
    - media_player.living_room_tv
    # - sensor.vibrant_color
  element: light.sony_tv_backlight
  state_action:
    action: call-service
    service: floorplan.style_set
    service_data:
      style: |
        >
        let mediaState = states['media_player.living_room_tv'].state;
        if (mediaState === "off" || mediaState === "idle" || mediaState === "unknown")
            return `
              display: none;
            `;

        let lightState = states['light.sony_tv_backlight'];
        if (lightState === undefined || lightState.state === "off" || lightState.state === "unavailable")
            return `
              fill: none;
              stroke: none;
              stroke-width: 0;
              stroke-dasharray: none;
              stroke-opacity: 0;
            `;



        let rgbcolor = states['sensor.vibrant_color'] ? `rgb(${states['sensor.vibrant_color'].state})` : "rgb(255, 255, 255)";

        let animation = mediaState === "playing" ? "5s ease-in-out 0s infinite strokeAnimation" : "";
        let fill = mediaState === "playing" ? rgbcolor : undefined;
        console.log("Media State:", mediaState, "Light State:", lightState.state, "RGB Color:", rgbcolor, "Animation:", animation);
        if (lightState.state === "on") {
          return `
            fill: ${fill};
            stroke: ${rgbcolor};
            stroke-width: 15 !important;
            filter: blur(1rem);
            stroke-dasharray: ${mediaState === "playing" ? 400 : 0};
            stroke-dashoffset: ${mediaState === "playing" ? 0 : 400};
            animation: ${animation};
            `;
        }

# - entity:
#     - media_player.bedroom_tv
#   double_tap_action: more-info
#   tap_action: !include ../shared/honeycomb/shield.yaml
#   state_action:
#     - service: floorplan.class_set
#       service_data: 'media-player-tv media-player-${entity.state}'
